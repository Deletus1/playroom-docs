# Using Unity with Playroom Kit

import { Callout } from 'nextra/components'
import Preview from '../../components/preview'

<Callout type="info" emoji="🧪">
    The Unity SDK currently only supports **Unity Web.** This is an experimental technology.
</Callout>

Unity is the most popular game engine, it's also a great way to make web games thanks to the [WebGL export option](https://docs.unity3d.com/Manual/webgl-building.html). 

Playroom Kit complements Unity by simplifying the development of multiplayer games and interactive web-based applications.

## Getting started

### Video Tutorial

<iframe width="560" height="315" src="https://www.youtube.com/embed/1LXWZmJxlKA?si=nKZOaoiEj_WwXt6X" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>

### 1. Install the SDK

1. Download `playroomkit.unitypackage` from the [releases page](https://github.com/asadm/playroom-unity/releases) (download `playroomkit.unitypackage` file).
2. Drag the package into your Unity project and import all files.
3. Open terminal, navigate to your project directory, and run:

```bash
cd Assets/PlayroomKit
npm install
```

This will install the required dependencies for the SDK.

### 2. Initialize Playroom

In your game's `Start` method, call `PlayroomKit.InsertCoin`:

```csharp
using Playroom;

void Start() {
    PlayroomKit.InsertCoin(new PlayroomKit.InitOptions()
    {
        maxPlayersPerRoom = 2,
        defaultPlayerStates = new() {
            {"score", -500},
        },
    }, () =>
    {
        // Game launch logic here
    });
}
```

### 3. Manage game state

Use `PlayroomKit.SetState` and `PlayroomKit.GetState` to handle game state. These automatically sync with other players.

See the [API reference](/apidocs/unity) for more information.

### 4. Export to WebGL

1. Go to `File > Build Settings` and select `WebGL` as the platform.
2. In Player Settings:
   - Set `Resolution and Presentation > Run In Background` to `true`.
   - Change `WebGL Template` to `PWA` (or to Discord, if you want to publish to Discord Activities).
   - Set `Compression Format` to `None` under `Publishing Settings` (this is to make sure the build works with most web servers including [itch.io](itch.io)).
3. Build your game.
4. Test locally using `python -m http.server` in the build folder.

{/* <!-- Image: A screenshot showing the Unity build settings window with the correct options highlighted --> */}

Do note that **PlayroomKit for Unity** only works with WebGL builds. 

## Testing your games

### Mock Mode

Since the current SDK only supports Unity Web, we've introduced **Mock mode** - a way to test out your game's logic in Unity's Preview mode, without having to build for web every single time.

#### 1. Local (simulated)
The "Local" mock mode doesn't connect to the actual Playroom server. Instead, it just mocks the API calls within Unity, and maintains a local state.

**The "Local" Mock mode only works in single player mode for now.** We aim to make it multiplayer by Q4.

| **✅ Pros**                                                                 | **👎 Cons**                                             |
|--------------------------------------------------------------------------|------------------------------------------------------|
| Super fast                                                             | There may be inconsistencies                       |
| Not much setup, lightweight                                            | Can't benchmark network load/bandwidth             |
| Can work offline                                                       | Doesn't have multiplayer (yet), single-player only                                                    |
| No impact on Playroom bill                                             |                                                      |


#### 2. Browser Bridge (live)
This mode connects to a live, multiplayer Playroom server. It will make real network calls, but to do so, it will launch a controlled browser (to run the underlying network calls).

| **✅ Pros**                                                                 | **👎 Cons**                                             |
|--------------------------------------------------------------------------|------------------------------------------------------|
| Live on Playroom servers, testers can join in from live games                        | Takes time to set up                               |
| Completely accurate according to production                           | Network dependent (can't develop offline)          |
|                                                                          | It will eat up your Playroom bill                  |

#### Which one should I use?

1. Start with **Local mock mode** for:
- Initial project setup
- Testing new features/algorithms
- Rapid iterations

2. Progress to **Browser Bridge mock mode** for:
- Realistic testing scenarios
- Multiplayer functionality
- Network performance evaluation

<Callout type="info" emoji="ℹ️">
    Remember that both mock modes in the Unity Editor approximate the final WebGL build. Some differences may occur due to the underlying C++ and JS compilation in the web environment.
</Callout>


### Multiple Player testing

The PlayroomKit for Unity plugin includes a "Playroom Dev Manager" panel for multi-instance testing and ease-of-use:

![Playroom Dev Manager](/images/playroom-dev-manager.png)

To test with multiple players:

1. Ensure the latest version of the [PlayroomKit plugin](http://localhost:3000/usage/unity#1-install-the-sdk) is installed.
2. Open the **Playroom Dev Manager** panel in Unity.
3. Click "Launch player" to create a new Unity Editor instance.
4. Repeat step 3 for additional player instances (limited by your computer's resources).

This feature uses [ParrelSync](https://github.com/VeriorPies/ParrelSync) Unity Editor to create multiple Unity Editor clones, each representing a different player.

<Callout emoji="🧠">
    **Tip:** Use this method to simulate various multiplayer scenarios and test synchronization between players without deploying your game.
</Callout>
 
By utilizing both Mock Modes and the Multiple Player testing feature, you can thoroughly test your game's multiplayer functionality and performance within the Unity environment before proceeding to a full WebGL build.

## Simple Example

Use `WASD` or `Arrow keys` to move the player around. The player's position is synced with other players in real-time.

Code for this example can be found [here](https://github.com/asadm/playroom-docs/tree/main/examples/unity-hello-world).

<Preview src="/demos/unity/index.html" newWindow />

## API Reference

See the [API reference](/apidocs/unity) for more information.

## FAQs and Tips

### How to display player's profile picture in Unity?
PlayroomPlayer.GetProfile().photo is formatted as `data:image/svg+xml,{svg encoded for url}`. In order to display it in Unity:
- Remove data:image/svg+xml from the string.
- Decode the rest using HttpUtility.UrlDecode()
- Display the result into an SVGImage component.

**Warning: Requires Unity's Vector Graphics package from com.unity.vectorgraphics which is an experimental package**

```csharp
 private void LoadSVG(string svgBytes) {
    // Split the string to escape the real data
    svgBytes = svgBytes.Split(",".ToCharArray(), 2)[1];
    // Decode from the URL encoding
    svgBytes = HttpUtility.UrlDecode(svgBytes);
    VectorUtils.TessellationOptions tesselationOptions = new VectorUtils.TessellationOptions();

    using (StringReader reader = new StringReader(svgBytes))
    {
        SVGParser.SceneInfo sceneInfo = SVGParser.ImportSVG(reader);
        tesselationOptions.MaxCordDeviation = float.MaxValue;
        tesselationOptions.MaxTanAngleDeviation = float.MaxValue;
        tesselationOptions.StepDistance = 1f;
        tesselationOptions.SamplingStepSize = 0.1f;

        List<VectorUtils.Geometry> geoms =
        VectorUtils.TessellateScene(sceneInfo.Scene, tesselationOptions);

        // Build a sprite with the tessellated geometry.
        Sprite sprite = VectorUtils.BuildSprite(geoms, 100.0f, VectorUtils.Alignment.Center, Vector2.zero, 128, true);
        sprite.name = "SVGimage";
        profilePicture.sprite = sprite;
    }
}
```

Thanks to **Zy** from our Discord for this tip.

### How to maintain an array of Players in Unity?
By maintaining an array of Players in your game, you can execute operations over multiple players all at once, and get the latest state of multiple players.
Here's a small snippet demonstrating how you can use [OnPlayerJoin](https://docs.joinplayroom.com/apidocs/unity#onplayerjoincallback) and [Player.OnQuit](https://docs.joinplayroom.com/apidocs/unity#onquitcallback) to achieve this.

```csharp
object[] players = Array.Empty<object>();
// ...
PlayroomKit.OnPlayerJoin((player) => {
  players.push(player)
  player.OnQuit(() => {
    Debug.Log($"{player.id} quit!");
    players.Where(p => p != player).ToArray();
  });
})
```

This may be considered an equivalent to the PlayroomKit JavaScript SDK's [usePlayersList hook](https://docs.joinplayroom.com/apidocs/react#useplayerslisttriggeronplayerstatechange-boolean).

### Aurea NetLayer: a higher level API for Unity

**GuilhermeAlanJohann** from our Discord community has created a [higher level plugin](https://gitlab.com/PCista/com.aurea.packages.netlayer) for Unity that makes it easier to use Playroom with Unity.


#### Features
- Sync position and rotations of objects over the network (supports interpolation)
- Different object authorities (Host and LocalPlayer)
- Spawn/Unspawn objects over the network
- Send Messages to others (including or excluding yourself)
- RPC (...kind of). It uses Unity message system.

